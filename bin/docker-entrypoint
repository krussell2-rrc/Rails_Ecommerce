#!/bin/bash -e

# Enable jemalloc if available
if [ -z "${LD_PRELOAD+x}" ]; then
  LD_PRELOAD=$(find /usr/lib -name libjemalloc.so.2 -print -quit)
  export LD_PRELOAD
fi

# Prefer migrations if they exist; otherwise fall back to schema load.
if ls db/migrate/*.rb >/dev/null 2>&1; then
  ./bin/rails db:migrate
else
  ./bin/rails db:schema:load
fi

# Hand off to whatever CMD was passed (thrust rails server by default)
exec "$@"
